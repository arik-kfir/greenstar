{{- $importDecimal := false }}
{{- $importTime := false }}
{{- range .model.Properties }}
{{- if eq .GoType "decimal.Decimal" }}{{ $importDecimal = true }}{{- end }}
{{- if eq .GoType "time.Time" }}{{ $importTime = true }}{{- end }}
{{- end }}
// Code generated by greenstar scripts; DO NOT EDIT.

package {{ .model.Name | toSnake }}

{{- if ne .model.Create nil }}

import (
	"encoding/json"
	"fmt"
	"github.com/arikkfir/greenstar/backend/internal/auth"
	"github.com/arikkfir/greenstar/backend/internal/server/util"
	{{- if $importDecimal }}
	"github.com/shopspring/decimal"
	{{- end }}
	"net/http"
	"slices"
	{{- if $importTime }}
	"time"
	{{- end }}
)

var (
	_ = decimal.Decimal{}
	_ = time.Time{}
)

type CreateRequest struct {
	{{- if eq .model.Scope modelScopeTenant }}
	TenantID string `json:"-"`
	{{- end }}
	{{- if .model.Create.AllowExplicitID }}
	ID string `json:"id,omitempty"`
	{{- end }}
	{{- range .model.Properties }}
	{{- if not .ReadOnly }}
	{{ .Name }} {{ if .Optional }}*{{ end }}{{ .GoType }} `json:"{{ .Name | toLowerCamelCase }},omitempty"`
	{{- end }}
	{{- end }}
	properties  []string
}

{{- if .model.Create.AllowExplicitID }}
func (lr *CreateRequest) HasID() bool { return slices.Contains(lr.properties, "id") }
{{- end }}
{{- range .model.Properties }}
{{- if .Optional }}
func (lr *CreateRequest) Has{{ .Name }}() bool { return slices.Contains(lr.properties, "{{ .Name | toLowerCamelCase }}") }
{{- end }}
{{- end }}
func (lr *CreateRequest) UnmarshalJSON(data []byte) error {
	lr.properties = nil
	var tempMap map[string]json.RawMessage
	if err := json.Unmarshal(data, &tempMap); err != nil {
		return err
	}
	for key := range tempMap {
		lr.properties = append(lr.properties, key)
	}
	type typeAlias CreateRequest
	alias := (*typeAlias)(lr)
	if err := json.Unmarshal(data, alias); err != nil {
		return err
	}
	return nil
}

type CreateResponse {{ .model.Name }}

func (s *Server) Create(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()

	l := util.Logger(ctx)

	{{- range .model.Create.Permissions }}
	{{- if eq .Scope modelScopeGlobal }}
	if !auth.GetToken(ctx).IsPermittedGlobally("{{ .Permission }}") {
		util.ServeError(w, r, util.ErrForbidden)
		l.WarnContext(ctx, "Access denied", "permission", "{{ .Permission }}")
		return
	}
	{{- else if eq .Scope modelScopeTenant }}
	if !auth.GetToken(ctx).IsPermittedForTenant(r.PathValue("{{ .TenantPathVariableName }}"), "{{ .Permission }}") {
		util.ServeError(w, r, util.ErrForbidden)
		l.With("tenantID", r.PathValue("TenantPathVariableName")).WarnContext(ctx, "Access denied", "permission", "{{ .Permission }}")
		return
	}
	{{- else }}
	{{- fail "unknown model scope: %s" .Scope }}
	{{- end }}
	{{- end }}

	req := CreateRequest{}
	if err := util.UnmarshalBody(r, &req); err != nil {
		util.ServeError(w, r, err)
		return
	}
	{{- if eq .model.Scope modelScopeTenant }}
	req.TenantID = r.PathValue("tenantID")
	if req.TenantID == "" {
		util.ServeError(w, r, fmt.Errorf("%w: invalid tenant ID", util.ErrBadRequest))
		return
	}
	{{- end }}

	res, err := s.h.Create(ctx, req)
	if err != nil {
		if code := util.ServeError(w, r, err); code >= http.StatusInternalServerError {
			l.ErrorContext(ctx, "Failed creating {{ .model.Name | lower }}", "err", err)
		}
		return
	}

	if err := util.Marshal(w, r, http.StatusCreated, res); err != nil {
		l.ErrorContext(ctx, "Failed marshaling {{ .model.Name | lower }}", "err", err)
		util.ServeError(w, r, err)
	}
}

{{- end }}
