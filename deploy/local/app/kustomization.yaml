apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
configMapGenerator:
  - name: greenstar-backend-config
    behavior: create
    envs: [ config/greenstar-backend-config.env ]
  - name: greenstar-frontend-config
    behavior: create
    envs: [ config/greenstar-frontend-config.env ]
secretGenerator:
  - name: greenstar-backend-secrets
    behavior: create
    envs: [ config/greenstar-backend-secrets.env ]
  - name: greenstar-frontend-secrets
    behavior: create
    envs: [ config/greenstar-frontend-secrets.env ]
  - name: greenstar-wildcard-tls
    type: kubernetes.io/tls
    behavior: create
    files:
      - tls.crt=tls/_wildcard.greenstar.test.pem
      - tls.key=tls/_wildcard.greenstar.test-key.pem
patches:

  # Debugging Go requires more memory
  - target:
      group: apps
      version: v1
      kind: Deployment
      labelSelector: app.kubernetes.io/component=backend
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            memory: 128Mi
          requests:
            memory: 128Mi
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-exclude-remote-addr
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=accept.*
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=access-control-.*
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=authorization
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=content-.*
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=cookie
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=origin
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=referer
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=sec\-.*
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=user-agent
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=vary
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=x-forwarded-.*
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=x-real-ip
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --http.access-log-excluded-headers=x-request-id

  # Locally we use frontend Dockerfile.debug which runs Node.js directly (no NGINX) thus longer startup time is required
  - target:
      group: apps
      version: v1
      kind: Deployment
      labelSelector: app.kubernetes.io/component=frontend
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/startupProbe/initialDelaySeconds
        value: 10
      - op: replace
        path: /spec/template/spec/containers/0/startupProbe/timeoutSeconds
        value: 30

  # Locally we use frontend Dockerfile.debug which runs Node.js directly (no NGINX) thus more memory is required
  - target:
      group: apps
      version: v1
      kind: Deployment
      labelSelector: app.kubernetes.io/component=frontend
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 2000m
            memory: 4Gi
          requests:
            cpu: 2000m
            memory: 4Gi
